name: Keep Render Service Alive

on:
  schedule:
    # Run every 10 minutes (prevent 15-minute spin down)
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping API Health Endpoint
        run: |
          echo "Pinging API to keep it alive..."
          
          if [ -z "${{ secrets.RENDER_API_URL }}" ]; then
            echo "ERROR: RENDER_API_URL secret is not configured!"
            echo "Please add the secret in GitHub Settings → Secrets and variables → Actions"
            exit 1
          fi
          
          API_URL="${{ secrets.RENDER_API_URL }}"
          echo "Attempting to ping: $API_URL/health"
          
          # Use curl with verbose error output and longer timeout
          response=$(curl -s -w "\n%{http_code}" -m 45 --connect-timeout 15 "$API_URL/health" 2>&1)
          http_code=$(echo "$response" | tail -n1)
          
          echo "Response code: $http_code"
          
          if [ "$http_code" = "200" ]; then
            echo "✓ API is alive and responsive"
          else
            echo "⚠ API returned status code: $http_code"
            echo "Full response:"
            echo "$response"
            # Don't exit with error - Render cold starts are normal
          fi
      
      - name: Ping System Status (Fallback)
        run: |
          echo "Checking system status endpoint..."
          API_URL="${{ secrets.RENDER_API_URL }}"
          curl -s -m 45 "$API_URL/api/system/status" | head -c 200 || echo "Status check could not reach API"
